#!/bin/sh
set -e

TEST_SCRIPT=""
if [ -f package.json ]; then
  TEST_SCRIPT=$(node -e "const fs=require('fs');try{const p=JSON.parse(fs.readFileSync('package.json','utf8'));process.stdout.write((p.scripts&&p.scripts.test)||'');}catch{}")
fi

if echo "$TEST_SCRIPT" | grep -qi "no test framework installed"; then
  echo "Skipping tests (no test framework)"
elif echo "$TEST_SCRIPT" | grep -q "vitest"; then
  if [ -x node_modules/.bin/vitest ]; then
    CI=1 npx vitest run --passWithNoTests
  else
    echo "Skipping vitest (not installed)"
  fi
else
  CI=1 npm run test --if-present
fi

npx lint-staged
